<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Management Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        .stock-item { padding: 10px; border: 1px solid #ddd; margin: 5px 0; }
        .loading { opacity: 0.6; }
    </style>
</head>
<body>
    <h1>üîß Data Management Test Page</h1>
    
    <div id="status" class="status info">Loading...</div>
    
    <h2>Cache Statistics</h2>
    <div id="cache-stats"></div>
    
    <h2>Stock Status</h2>
    <div id="stock-status"></div>
    
    <h2>Manual Actions</h2>
    <button onclick="refreshStatus()">üîÑ Refresh Status</button>
    <button onclick="refreshStock('ERIC-B')">üîÑ Refresh ERIC-B</button>
    <button onclick="refreshStock('VOLV-B')">üîÑ Refresh VOLV-B</button>
    
    <script>
        const API_BASE = 'http://localhost:8000';
        
        async function fetchStatus() {
            try {
                const response = await fetch(`${API_BASE}/data/status/detailed`);
                const data = await response.json();
                
                // Update cache stats
                const cacheStats = data.cache_stats;
                document.getElementById('cache-stats').innerHTML = `
                    <div class="status success">
                        üìä Total Entries: ${cacheStats.total_entries} | 
                        Valid: ${cacheStats.valid_entries} | 
                        Efficiency: ${cacheStats.cache_efficiency} | 
                        Hits: ${cacheStats.total_hits}
                    </div>
                `;
                
                // Update stock status
                const stockHtml = data.stock_status.map(stock => {
                    const status = stock.fetch_success === false ? '‚ùå' : 
                                 !stock.has_data ? '‚ö™' : '‚úÖ';
                    const lastUpdate = stock.last_updated ? 
                        new Date(stock.last_updated).toLocaleString() : 'Never';
                    
                    return `
                        <div class="stock-item">
                            ${status} <strong>${stock.ticker}</strong> 
                            (ID: ${stock.stock_id || 'N/A'}) - 
                            Last: ${lastUpdate}
                            ${stock.error ? `<br>Error: ${stock.error}` : ''}
                        </div>
                    `;
                }).join('');
                
                document.getElementById('stock-status').innerHTML = stockHtml;
                document.getElementById('status').innerHTML = 
                    `<div class="status success">‚úÖ Status updated: ${new Date().toLocaleTimeString()}</div>`;
                
            } catch (error) {
                document.getElementById('status').innerHTML = 
                    `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function refreshStock(ticker) {
            const button = event.target;
            button.disabled = true;
            button.textContent = '‚è≥ Refreshing...';
            
            try {
                const response = await fetch(`${API_BASE}/data/refresh-stock/${ticker}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('status').innerHTML = 
                        `<div class="status success">‚úÖ ${ticker} refreshed: ${data.name} | ${data.price} SEK</div>`;
                    await fetchStatus(); // Refresh the status display
                } else {
                    document.getElementById('status').innerHTML = 
                        `<div class="status error">‚ùå Failed to refresh ${ticker}: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('status').innerHTML = 
                    `<div class="status error">‚ùå Error refreshing ${ticker}: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                button.textContent = `üîÑ Refresh ${ticker}`;
            }
        }
        
        function refreshStatus() {
            fetchStatus();
        }
        
        // Initial load and auto-refresh
        fetchStatus();
        setInterval(fetchStatus, 30000); // Refresh every 30 seconds
    </script>
</body>
</html>
